# Сервис объявлений на FastAPI (с управлением пользователями)

Это учебный проект сервиса для управления объявлениями и пользователями, разработанный на FastAPI с использованием PostgreSQL в качестве базы данных и докеризацией для простоты развертывания. Проект включает аутентификацию на основе JWT токенов и систему прав доступа для пользователей.

## Возможности

**Управление объявлениями:**

* Создание объявлений (заголовок, описание, цена, автор) _(требуется аутентификация)_
* Получение объявления по ID _(доступно всем)_
* Поиск объявлений по различным параметрам (заголовок, автор, цена) _(доступно всем)_
* Обновление существующих объявлений _(только владелец объявления или администратор)_
* Удаление объявлений _(только владелец объявления или администратор)_

**Управление пользователями и аутентификация:**

* Регистрация новых пользователей _(доступно всем)_
* Аутентификация пользователей (логин) с получением JWT токена _(доступно всем)_
* Получение информации о пользователе по ID _(доступно всем)_
* Получение списка всех пользователей _(только администраторы)_
* Обновление данных своего профиля _(только аутентифицированный пользователь для своих данных)_
* Обновление данных любого пользователя _(только администраторы)_
* Удаление своего профиля _(только аутентифицированный пользователь для своего профиля)_
* Удаление любого пользователя _(только администраторы)_
* Разделение пользователей на группы: `user` и `admin` с разными правами доступа.
* Автоматическое создание пользователя-администратора при первом запуске (настраивается через `.env`).

## Права доступа

* **Неавторизованный пользователь:**
  * Регистрация нового пользователя (`POST /user`)
  * Получение информации о любом пользователе по ID (`GET /user/{user_id}`)
  * Вход в систему для получения токена (`POST /login`)
  * Получение объявления по ID (`GET /advertisement/{advertisement_id}`)
  * Поиск объявлений (`GET /advertisement`)
* **Авторизованный пользователь (группа `user`):**
  * Все права неавторизованного пользователя.
  * Обновление данных своего профиля (`PATCH /user/{user_id}` где `user_id` - его ID).
  * Удаление своего профиля (`DELETE /user/{user_id}` где `user_id` - его ID).
  * Создание нового объявления (`POST /advertisement`).
  * Обновление своих объявлений (`PATCH /advertisement/{advertisement_id}`).
  * Удаление своих объявлений (`DELETE /advertisement/{advertisement_id}`).
* **Авторизованный пользователь (группа `admin`):**
  * Все права пользователя группы `user`.
  * Получение списка всех пользователей (`GET /user`).
  * Обновление данных любого пользователя, включая изменение группы (`PATCH /user/{user_id}`).
  * Удаление любого пользователя (`DELETE /user/{user_id}`).
  * Обновление любого объявления (`PATCH /advertisement/{advertisement_id}`).
  * Удаление любого объявления (`DELETE /advertisement/{advertisement_id}`).

При попытке выполнить действие без достаточных прав, API вернет ошибку `403 Forbidden`. При проблемах с аутентификацией (неверный токен, отсутствующий токен для защищенных роутов) — `401 Unauthorized`.

## Технологии

* Python 3.11+
* FastAPI
* SQLAlchemy (асинхронный режим с `asyncpg`)
* Pydantic (для валидации данных)
* PostgreSQL
* Docker & Docker Compose
* Uvicorn (ASGI сервер)
* Passlib (для хеширования паролей)
* Python-JOSE (для работы с JWT токенами)

## Подготовка к запуску

Перед запуском проекта убедитесь, что у вас установлены:

* [Docker](https://www.docker.com/get-started)
* [Docker Compose](https://docs.docker.com/compose/install/) (обычно идет вместе с Docker Desktop)

## Запуск проекта (с использованием Docker Compose)

Предполагается, что вы уже получили исходный код проекта (например, склонировали репозиторий) и находитесь в корневой папке проекта.

1. **Настройте переменные окружения:**
   В корневой папке проекта должен присутствовать файл `.env`. Если его нет, создайте его, скопировав содержимое из `env.example` (если такой файл предоставлен) или создав с нуля.
   Пример минимальной конфигурации `.env`:

   ```dotenv
   # PostgreSQL settings
   POSTGRES_USER=user
   POSTGRES_PASSWORD=password
   POSTGRES_SERVER=db # Для Docker Compose
   POSTGRES_PORT=5432
   POSTGRES_DB=ads_db

   # JWT Settings
   JWT_SECRET_KEY="ВАШ_ОЧЕНЬ_СЕКРЕТНЫЙ_И_ДЛИННЫЙ_КЛЮЧ" # Замените на свой ключ!
   ALGORITHM="HS256"
   ACCESS_TOKEN_EXPIRE_MINUTES=2880 # 48 часов (в минутах)

   # Admin User Settings (для автоматического создания при старте)
   ADMIN_USERNAME=admin
   ADMIN_EMAIL=admin@example.com
   ADMIN_PASSWORD=strongadminpassword
   ```

   **Важно:** Замените `JWT_SECRET_KEY` на свой собственный, сгенерированный случайным образом (например, с помощью `python -c "import secrets; print(secrets.token_urlsafe(32))"`).
   Значение `POSTGRES_SERVER` должно быть `db` (имя сервиса базы данных в `docker-compose.yml`). Остальные значения `POSTGRES_*` должны соответствовать тем, что ожидает сервис PostgreSQL в `docker-compose.yml`.
   Переменные `ADMIN_*` используются для автоматического создания администратора при первом запуске приложения, если он еще не существует.
2. **Соберите образы и запустите контейнеры:**
   Выполните следующую команду в корневой папке проекта:

   ```bash
   docker-compose up --build
   ```

   Эта команда соберет Docker-образ для FastAPI приложения и запустит контейнеры для приложения и базы данных PostgreSQL.
   Параметр `--build` нужен при первом запуске или если вы вносили изменения в `Dockerfile`. Для последующих запусков обычно достаточно `docker-compose up`.
3. **Проверка:**

   * Приложение будет доступно по адресу `http://127.0.0.1:8000`.
   * Интерактивная документация API (Swagger UI) доступна по адресу `http://127.0.0.1:8000/docs`.
   * Альтернативная документация (ReDoc) доступна по адресу `http://127.0.0.1:8000/redoc`.

   При первом запуске (или если настроено `drop_all` в коде) таблицы в базе данных будут созданы (или пересозданы) автоматически, включая пользователя-администратора по умолчанию.

## Взаимодействие с API через Swagger UI

1. **Регистрация и вход:**
   * Используйте эндпоинт `POST /user` для создания нового пользователя.
   * Используйте эндпоинт `POST /login` с вашим именем пользователя и паролем для получения `access_token`.
2. **Авторизация в Swagger:**
   * Скопируйте полученный `access_token`.
   * Нажмите кнопку "Authorize" в правом верхнем углу Swagger UI.
   * В появившемся окне вставьте токен в формате `Bearer <ваш_токен>` (например, `Bearer eyJhbGciOi...`) и нажмите "Authorize".
3. **Выполнение запросов:**
   Теперь вы можете выполнять запросы к защищенным эндпоинтам от имени авторизованного пользователя.

## Запуск для локальной разработки (без Docker)

1. Убедитесь, что у вас установлен Python 3.11+ и Poetry (или pip).
2. Установите и запустите PostgreSQL локально.
3. Создайте файл `.env` и настройте `POSTGRES_SERVER=localhost` (или адрес вашего локального сервера PostgreSQL), а также остальные переменные `POSTGRES_*` и `JWT_*`.
4. Создайте и активируйте виртуальное окружение:

   ```bash
   python -m venv venv
   source venv/bin/activate # для Linux/macOS
   # venv\Scripts\activate # для Windows
   ```
5. Установите зависимости:

   ```bash
   pip install -r requirements.txt
   ```
6. Запустите приложение:

   ```bash
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

   Приложение будет доступно на `http://127.0.0.1:8000`.

## Остановка проекта (Docker Compose)

Чтобы остановить запущенные контейнеры, нажмите `Ctrl+C` в терминале, где выполняется `docker-compose up`.
Затем, чтобы полностью остановить и удалить контейнеры (данные в томе `postgres_data` сохранятся):

```bash
docker-compose down
```
