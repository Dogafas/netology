# Asyncio SWAPI Проект

Этот проект демонстрирует асинхронное Python-приложение, которое загружает данные из API Star Wars (SWAPI) и сохраняет их в базу данных PostgreSQL с использованием SQLAlchemy и aiohttp. Проект контейнеризирован с помощью Docker и включает скрипт для пересоздания базы данных.

### Основные файлы

- **docker-compose.yml**: Определяет сервис PostgreSQL, работающий на порту 5431.
- **models.py**: Содержит модели ORM SQLAlchemy и логику инициализации базы данных.
- **my_async_requests.py**: Основной скрипт для асинхронной загрузки и сохранения данных SWAPI.
- **recreate_db.sh**: Bash-скрипт для удаления и пересоздания базы данных PostgreSQL.
- **.env**: Переменные окружения для конфигурации PostgreSQL.

## Требования

- Docker и Docker Compose
- Python 3.11+
- Клиент PostgreSQL (для выполнения `recreate_db.sh`)

## Инструкция по запуску

1. **Клонирование репозитория** (если применимо):

   ```bash
   git clone <url-репозитория>
   cd asyncio/async_112
   ```
2. **Настройка переменных окружения**:
   Убедитесь, что файл `.env` находится в папке `async_112` и содержит следующее:

   ```
   POSTGRES_PASSWORD=secret
   POSTGRES_USER=swapi
   POSTGRES_DB=swapi
   ```
3. **Запуск PostgreSQL с помощью Docker**:
   Выполните следующую команду, чтобы запустить контейнер PostgreSQL:

   ```bash
   docker-compose up -d
   ```
4. **Пересоздание базы данных**:
   Сделайте скрипт `recreate_db.sh` исполняемым и запустите его для удаления и пересоздания базы данных `swapi`:

   ```bash
   chmod +x recreate_db.sh
   ./recreate_db.sh
   ```
5. **Установка зависимостей Python**:
   Настройте виртуальное окружение и установите необходимые пакеты:

   ```bash
   python -m venv venv
   source venv/bin/activate  # Для Windows: venv\Scripts\activate
   pip install -r requirements.txt
   ```
6. **Запуск приложения**:
   Выполните основной скрипт для загрузки данных из SWAPI и их сохранения в базе данных:

   ```bash
   python my_async_requests.py
   ```

## Как это работает

- **Настройка базы данных**:

  - Файл `docker-compose.yml` настраивает контейнер PostgreSQL с базой данных `swapi`, доступной на порту `5431`.
  - Скрипт `recreate_db.sh` удаляет и пересоздает базу данных `swapi`.
- **Модели ORM**:

  - Файл `models.py` определяет модель `SwapiPeople` с использованием асинхронного ORM SQLAlchemy, отображаемую в таблице `swapi_people`.
  - Функция `init_orm` создает таблицу, а `close_orm` освобождает ресурсы движка.
- **Загрузка данных**:

  - Скрипт `my_async_requests.py` использует `aiohttp` для асинхронной загрузки данных из конечной точки SWAPI `/people/`.
  - Запросы ограничены 5 одновременными соединениями (`MAX_REQUESTS`) с использованием `more_itertools.chunked`.
  - Индикатор выполнения (`tqdm`) отслеживает процесс загрузки.
  - Данные каждого персонажа преобразуются в словарь и сохраняются в базе данных с использованием модели `SwapiPeople`.
- **Обработка ошибок**:

  - Скрипт обрабатывает ошибки HTTP 404 (отсутствующие персонажи) и другие клиентские ошибки, выводя их в консоль.

## Использование

- Скрипт загружает данные для всех персонажей SWAPI (до общего количества, указанного в API) и сохраняет их в таблице `swapi_people`.
- Время выполнения выводится в консоль по завершении.

Пример вывода:

```
Загрузка персонажей: 100%|██████████| 82/82 [00:05<00:00, 14.67it/s]
Execution time: 0:00:05.592123
```

## Устранение неполадок

- **Проблемы с подключением к базе данных**:

  - Убедитесь, что контейнер PostgreSQL запущен (`docker ps`).
  - Проверьте, что переменные в `.env` соответствуют учетным данным в `models.py` и `recreate_db.sh`.
- **Ошибка "Permission Denied" для `recreate_db.sh`**:

  - Выполните `chmod +x recreate_db.sh`, чтобы сделать скрипт исполняемым.
- **Отсутствующие зависимости**:

  - Убедитесь, что все зависимости установлены с помощью `pip install -r requirements.txt`.

## Примечания

- Проект предполагает, что API SWAPI доступен по адресу `https://swapi.dev/api/people/`.
- База данных настроена на порт `5431`, чтобы избежать конфликтов с локальным PostgreSQL на стандартном порту `5432`.
- Скрипт использует `asyncpg` в качестве драйвера PostgreSQL для асинхронных операций.
